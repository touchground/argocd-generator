name: 'Generate ArgoCD Application'
description: 'Generates an ArgoCD application YAML file'
inputs:
  appName:
    description: 'Application name'
    required: true
  repoUrl:
    description: 'Repository URL'
    required: true
  manifestsPath:
    description: 'Path to Kubernetes manifests in the repository'
    required: true
  namespace:
    description: 'Destination namespace'
    required: true
  syncPolicy:
    description: 'Sync policy'
    required: false
    default: 'automated'
  templatePath:
    description: 'Path to save the generated YAML file'
    required: false
    default: '.'
  env:
    description: 'Environment Name'
    required: false
    default: ''
  automated:
    description: 'Automated sync policy'
    required: false
    default: 'false'
  autoPrune:
    description: 'Auto prune policy'
    required: false
    default: 'false'
  selfHeal:
    description: 'Self heal policy'
    required: false
    default: 'false'
  envPrefix:
    description: 'Add environment prefix to add to the application name'
    required: false
    default: 'false'

runs:
  using: 'composite'
  steps:
    - name: Set Application Name
      id: setAppName
      run: |
        if [[ "${{ inputs.envPrefix }}" == "true" ]]; then
            appName="${{ inputs.env }}-"
        else
            appName=""
        fi
        appName+="${{ inputs.appName }}"
        echo "name=$appName" >> $GITHUB_OUTPUT
      shell: bash

    - name: Generate ArgoCD Application
      run: |
        template='
        apiVersion: argoproj.io/v1alpha1
        kind: Application
        metadata:
          name: ${{ steps.setAppName.outputs.name }}
          namespace: argocd
          finalizers:
          - resources-finalizer.argocd.argoproj.io
        spec:
          project: default
          source:
            repoURL: {{ .Values.spec.source.repoURL }}
            targetRevision: {{ .Values.spec.source.targetRevision }}
            path: ${{ inputs.manifestsPath }}
          destination:
            server: {{ .Values.spec.destination.server }}
            namespace: ${{ inputs.namespace }}
          syncPolicy:'

        # Check if automated is set to true
        if [[ "${{ inputs.automated }}" == "false" ]]; then
          template+="\n    automated: {}"
        else
          template+="\n    automated: \n      prune: \${{ inputs.autoPrune }}\n      selfHeal: \${{ inputs.selfHeal }}"
        fi
        
        echo "${template}" > ${{ inputs.templatePath }}/${{ inputs.appName }}.yaml
      shell: bash